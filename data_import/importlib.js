// Generated by CoffeeScript 1.6.3
(function() {
  var Throttle, XmlPath, cacheHtml, currentNamespaceId, currentPage, fs, http, inInitMode, indexName, maxConcurrentTransformations, namespaces, pageCount, pageQueue, runningConcurrentTransformations, sax, saxStream, saxStreamFinished, saxStreamOptions, storePageToES, strict, throttle, wikijs, wikipediaDataPath, xmlPath;

  saxStreamFinished = function() {
    return console.log('FINISHED');
  };

  storePageToES = function(page) {
    var options, req, title;
    if (cacheHtml && page['text'] !== void 0) {
      page['html'] = wikijs.process(page['text']);
    }
    title = page['title'];
    options = {
      host: 'localhost',
      port: 9200,
      path: ("/" + indexName + "/page/") + encodeURIComponent(title),
      method: 'PUT'
    };
    req = http.request(options, function(res) {
      var shouldLog;
      shouldLog = false;
      if (res.statusCode !== 201) {
        shouldLog = true;
      }
      if (shouldLog) {
        console.log("PAGE: " + title);
        console.log('HEADERS: ' + JSON.stringify(res.headers));
      }
      res.on('data', function(chunk) {
        if (shouldLog) {
          return console.log('BODY: ' + chunk);
        }
      });
      return res.on('error', function(e) {
        return console.log(("problem with the response " + title + ": ") + e.message);
      });
    });
    req.on('error', function(e) {
      return console.log(("problem with request " + title + ": ") + e.message);
    });
    req.write(JSON.stringify(page));
    return req.end();
  };

  fs = require('fs');

  sax = require('sax');

  http = require('http');

  wikijs = require('wiky.js');

  Throttle = require('throttle');

  XmlPath = require('./XmlPath');

  maxConcurrentTransformations = 48;

  runningConcurrentTransformations = 0;

  pageQueue = [];

  throttle = new Throttle(128 * 1024);

  cacheHtml = false;

  if (cacheHtml) {
    indexName = 'wikipedia_cached';
  } else {
    indexName = 'wikipedia';
  }

  xmlPath = new XmlPath;

  wikipediaDataPath = process.argv[2];

  pageCount = 0;

  wikijs.options['link-image'] = false;

  strict = true;

  saxStreamOptions = {
    trim: true,
    normalize: true,
    lowercase: true
  };

  saxStream = sax.createStream(strict, saxStreamOptions);

  inInitMode = true;

  currentNamespaceId = void 0;

  currentPage = void 0;

  namespaces = {};

  saxStream.onopentag = function(node) {
    xmlPath.push(node.name);
    if (inInitMode) {
      if (node.name === 'namespace') {
        return currentNamespaceId = node.attributes['key'];
      }
    } else if (node.name === 'page') {
      return currentPage = {
        'view_count': 0
      };
    } else if (node.name === 'redirect') {
      return currentPage['redirect_to'] = node.attributes['title'];
    }
  };

  saxStream.ontext = function(text) {
    if (currentNamespaceId !== void 0) {
      return namespaces[currentNamespaceId] = text;
    } else {
      switch (xmlPath.peek()) {
        case 'title':
          return currentPage['title'] = text;
        case 'text':
          return currentPage['text'] = text;
        case 'ns':
          return currentPage['type'] = namespaces[text];
        case 'timestamp':
          return currentPage['timestamp'] = text;
        case 'comment':
          return currentPage['comment'] = text;
        case 'username':
          return currentPage['contributor_name'] = text;
        case 'ip':
          return currentPage['contributor_ip'] = text;
      }
    }
  };

  saxStream.onclosetag = function(nodeName) {
    xmlPath.pop();
    if (inInitMode) {
      if (nodeName === 'namespaces') {
        inInitMode = false;
        return currentNamespaceId = void 0;
      }
    } else if (nodeName === 'page') {
      storePageToES(currentPage);
      pageCount++;
      if (pageCount % 1000 === 0) {
        return console.log("Finished " + pageCount + " pages");
      }
    } else if (xmlPath.isEmpty()) {
      return saxStreamFinished();
    }
  };

  fs.createReadStream(wikipediaDataPath).pipe(throttle).pipe(saxStream);

}).call(this);
